<!DOCTYPE html>
<html>
<head>
  <title><%= title %></title>
  <%= stylesheet_link_tag :all %>
  <%= javascript_include_tag :defaults %>
  <%= stylesheet_link_tag 'blueprint/screen', :media => 'screen' %>
  <%= stylesheet_link_tag 'blueprint/print', :media => 'print' %>
  <%= stylesheet_link_tag 'custom', :media => 'screen' %>
  <!--[if lt IE 9]>
  <script type="text/javascript" src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <!--[if lt IE 8]><%= stylesheet_link_tag 'blueprint/ie' %><![endif]-->
  <%= csrf_meta_tag %>

  <script type="text/javascript" src="http://api.maps.yahoo.com/ajaxymap?v=3.8&appid=cPrzZnXV34E1Be7zGk9B8F.LZ4ZNi6lrz_uVWDxnkUrNLJ0bODvK3QcKGlhgzdh_cg--"></script>
  <link type="text/css" rel="stylesheet" href="http://yui.yahooapis.com/3.3.0/build/cssfonts/fonts-min.css"/>
  <script type="text/javascript" src="http://yui.yahooapis.com/3.3.0/build/yui/yui-min.js"></script>
</head>
<body>
<div class="container">
  <section>
    <div id="content" class="round">
      <div id="content_bg" class="round">
        <%= yield %>
      </div>
    </div>
    <div id="map"></div>

    <script type="text/javascript">
        // Create a map object
        var map = new YMap(document.getElementById('map'));
        map.disableKeyControls();
        // Add map type control
        map.addTypeControl();
        // Set map type to either of: YAHOO_MAP_SAT, YAHOO_MAP_HYB, YAHOO_MAP_REG
        map.setMapType(YAHOO_MAP_REG);

        // Display the map centered on a geocoded location
        map.drawZoomAndCenter("<%= location.gsub(";", ",") %>", 4);

        <% if !@pits.nil? %>
        <% @pits.each do |pit|%>
            var currentGeoPoint = new YGeoPoint(<%= pit.latitude %>, <%= pit.longitude %>);
            map.addMarker(currentGeoPoint);
        <% end %>
        <% end %>
    </script>
    <script type="text/javascript">
        YUI().use("autocomplete", "node", "datasource-get", "autocomplete-highlighters", "datasource-io", "datasource-jsonschema", function (Y) {
            Y.one('body').addClass('yui3-skin-sam');
            // Create a DataSource instance.
            var ds = new Y.DataSource.IO({
                source: './locations.json'
            });

            ds.plug({fn: Y.Plugin.DataSourceJSONSchema, cfg: {
                schema: {
                    resultListLocator: "Results.data",
                    resultFields: ["id", "name"]
                }
            }});

            document.getElementById('search_term').focus();

            var inputNode = Y.one('#search_term').plug(Y.Plugin.AutoComplete, {
                maxResults: 10,
                minQueryLength: 0,
                resultHighlighter: 'wordMatch',
                source: ds,
                resultTextLocator: function (result) {
                    return result["name"].toString();
                },
                requestTemplate: '?search={query}'
            });

            inputNode.ac.on('results', function (e) {
                if (e.results.length) {
                    var found = false;
                    for (var r in e.results) {
                        if (e.results[r] == inputNode.ac.get('value')) {
                            found = true;
                        }
                    }
                    if (!found) {
                        inputNode.ac.set('value', e.results[0].display);
                    }
                }
            });
        });
    </script>
  </section>
</div>
</body>
</html>